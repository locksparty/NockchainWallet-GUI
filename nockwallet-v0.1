#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Nockchain Wallet Qt Interface v2.2.2
Interface graphique pour le wallet Nockchain
"""

import sys
import subprocess
import logging
import time
from pathlib import Path
from typing import Optional, Dict, Any, List, Tuple
import re
import json  # Ajout pour le support du JSON de config

from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QLabel, QLineEdit, QTextEdit, QFileDialog,
    QMessageBox, QTabWidget, QGroupBox, QRadioButton, QCheckBox,
    QTableWidget, QTableWidgetItem, QHeaderView, QStatusBar, QComboBox,
    QSpinBox
)
from PyQt6.QtCore import Qt, QTimer
from PyQt6.QtGui import QFont, QPalette, QColor

from transaction_engine import TransactionEngine, TransactionResult

# Configuration du logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Gestion et lecture de la configuration globale depuis config.json
CONFIG_FILE = Path(__file__).parent / "config.json"

default_config = {
    'wallet_binary': 'nockchain-wallet',
    'wallet_path': '',
    'wallet_imported': False,
    'client_type': 'public',
    'public_server': 'https://nockchain-api.zorp.io',
    'private_port': '50051'
}

def load_config():
    try:
        if CONFIG_FILE.exists():
            with open(CONFIG_FILE, "r", encoding="utf-8") as f:
                config_data = json.load(f)
                merged = {**default_config, **config_data}
                return merged
    except Exception as e:
        logger.error(f"Erreur lecture config.json: {e}")
    return default_config.copy()

def save_config():
    try:
        with open(CONFIG_FILE, "w", encoding="utf-8") as f:
            json.dump(config, f, indent=4, ensure_ascii=False)
        logger.info("Configuration sauvegardée.")
    except Exception as e:
        logger.error(f"Erreur sauvegarde config.json: {e}")

config = load_config()

# ---- RESTE DU CODE INCHANGÉ (rappel : change seulement _save_params ci-dessous) ----

class NockchainWalletGUI(QMainWindow):
    # tout le reste inchangé…
    def _save_params(self):
        """Sauvegarde les paramètres"""
        config['wallet_binary'] = self.binary_path_input.text()
        config['client_type'] = 'public' if self.public_client_rb.isChecked() else 'private'
        config['public_server'] = self.public_server_input.text()
        config['private_port'] = self.private_port_input.text()
        
        # Réinitialiser le moteur de transaction
        self._init_transaction_engine()
        
        save_config()  # ENREGISTRE VERS config.json
        
        self.log_area.append_log("✓ Paramètres sauvegardés", "success")
        QMessageBox.information(self, "Succès", "Paramètres sauvegardés")
        self._check_binary()

# ---- reste inchangé ----
